"use strict";var app=angular.module("adminPanelApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]);app.config(["$routeProvider",function(a){a.when("/:dataType/:id/:childId",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).when("/:dataType/:id",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).when("/:dataType",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).otherwise({redirectTo:"/user"})}]).constant("FIREBASE_URL","https://staging-grouper.firebaseio.com/"),app.controller("DynamicCtrl",["$scope","$routeParams","$firebaseSimpleLogin","$filter","FIREBASE_URL","Library","DataLoader","Grouper",function(a,b,c,d,e,f,g,h){a.test=function(){console.log("Scope.auth",a.auth)};var i=function(b,c){b?(console.log("Error logging in: ",b),console.log('If you are an admin, you can add yourself to the "admin"-directory: '+e+"admin"),console.log('Create an entry with the key "github:<your github id>". Find your github id here: http://caius.github.io/github_id/')):c?(console.log("User UID: "+c.uid),a.setData()):console.log("Not logged in")},j=new Firebase(e);a.auth=c(j),new FirebaseSimpleLogin(j,i),a.dataType=b.dataType,a.id=b.id,a.childId=b.childId,a.types=f.types,a.firebaseTypeUrl=e+a.dataType+"/";var k=function(){if("undefined"!=typeof a.id&&"undefined"!=typeof a.childId)var b=a.id+"/"+a.childId;else var b=a.id;return b},l=function(){a.data={},a.data.objects=g.data.objects,a.data.keys=g.data.keys,a.data.formattedKeys=g.data.formattedKeys};a.setData=function(){g.get(a.dataType,k()),l()},a.forceReload=function(){g.load(a.dataType,k()),l(),n()},a.search=function(b){a.data.objects=d("mySearchFilter")(g.data.objects,b)},a.predicate="",a.reverse=!1,a.setSortingPredicate=function(b){a.predicate===b?a.reverse=!a.reverse:(a.reverse=!1,a.predicate=b),a.data.objects=d("mySortFilter")(a.data.objects,a.predicate,a.reverse)};var m=[];a.selectedObjects=[],a.toggleSelectedRow=function(b,c){var d=m.indexOf(b);-1===d?(m.push(b),a.selectedObjects.push(a.data.objects[c])):(m.splice(d,1),a.selectedObjects.splice(d,1))},a.isSelected=function(a){return-1!==m.indexOf(a)},a.deleteSelected=function(){angular.forEach(a.selectedObjects,function(b){switch(a.dataType){case"event":h.deleteEvent(b.id);break;case"user":h.deleteUser(b.id);break;case"group":h.deleteGroup(b.id);break;case"notice":h.deleteNotice(b.id);break;default:console.log("Could not delete: Type unknown! Wtf? ")}delete a.data.objects[b.id]}),m=[],a.selectedObjects=[]},a.toggleKey=function(b){var c=a.keys.show.indexOf(b);return c>-1?(a.keys.show.splice(c,1),void a.keys.hide.push(b)):(c=a.keys.hide.indexOf(b),void(c>-1&&(a.keys.hide.splice(c,1),a.keys.show.push(b))))},a.move=function(b,c){for(var d=["show","hide"],e=0;e<d.length;e++){var f=d[e],g=a.keys[f].indexOf(b);if(0===g&&0>c)return;g>-1&&(a.keys[f].splice(g,1),a.keys[f].splice(g+c,0,b))}};var n=function(){var b=new Firebase(f.urlOfKeys(a.dataType));b.on("value",function(b){var c=b.val();if(a.keys=c,a.formattedKeys={},!c)return void console.log("Keys not found at: ",f.urlOfKeys(a.dataType));a.keys.show||(a.keys.show=[]),a.keys.hide||(a.keys.hide=[]);for(var d=c.show.concat(c.hide),e=0;e<d.length;e++){var g=d[e];a.formattedKeys[g]=f.readableKey(g)}}),a.keysToFirebase=function(){b.set(a.keys)}};n()}]),app.factory("DataLoader",["FIREBASE_URL","Library","$filter",function(a,b,c){var d={},e={},f=function(){return{objects:{},keys:{show:[],hide:[]},formattedKeys:{show:{},hide:{}}}};return d.get=function(a,b){e[a]?d.swap(a,b):d.load(a,b)},d.swap=function(a,b){console.log("swap");var c=f();d.data=c,c.keys=e[a].keys,c.formattedKeys=e[a].formattedKeys,b?(c.objects={},c.objects[b]=e[a].objects[b]):c.objects=e[a].objects},d.load=function(g,h){console.log("load");var i=new Firebase(a+g),j=new Firebase(a+g+"/"+h),k=new Firebase(b.urlOfKeys(g)+"/show"),l=(new Firebase(b.urlOfKeys(g)+"/hide"),f());d.data=l;var m=function(d,e,f){var h=f,i=function(a,b){var c;return c="message"===a?a+"/"+h+"/"+b:a+"/"+b},j=function(c,d,e,f){var g=i(e,f),h=a+g,j=b.primaryPropertyOf(e);new Firebase(h).on("value",function(a){var b=a.val();c[d]=b?{ref:g,value:b[j]?b[j]:f}:{value:f}})},k=function(a,c,d){var e=0,f=b.typeOf(d);angular.forEach(a,function(a,b){j(c,e++,f,b)})},m="MMM d yyyy, H:mm",n=function(d,e,f){if("object"==typeof f)k(f,d[e]=[],e);else{if("string"==typeof f){d[e]=[{value:f}];var j=function(){var c=b.typeOf(e);if(void 0!==typeof c){var g=f,h=i(c,g),j=a+h,k=b.primaryPropertyOf(c);try{var l=new Firebase(j);l.on("value",function(a){var b=a.val();d[e]=b?[{ref:h,value:b[k]?b[k]:g}]:[{value:g}]})}catch(m){}}};j()}else d[e]="number"==typeof f?[{value:c("date")(f,m),unixTime:f}]:"boolean"==typeof f?[{value:f}]:[{value:" [TYPE ERROR] ("+typeof f+") : "+f}];e===b.primaryPropertyOf(g)&&(d[e][0].ref=i(g,h))}};angular.forEach(d,function(a,b){l.keys.show.indexOf(b)>-1&&n(e,b,a)})},n=function(){j.on("value",function(a){var b=a.val(),c={id:h};l.objects[h]=c,m(b,c,h)})},o=function(){e[g]=l,i.on("value",function(a){angular.forEach(a.val(),function(a,b){var c={id:b};l.objects[b]=c,m(a,c,b)})})},p=function(){"undefined"!=typeof h?n():o()},q=function(a){var c=function(){console.log("Generate keys from data"),i.on("value",function(a){l.keys.show=[];var c=a.val();"message"===g?angular.forEach(c,function(a){angular.forEach(a,function(a){angular.forEach(a,function(a,c){-1===l.keys.show.indexOf(c)&&(l.keys.show.push(c),l.formattedKeys.show[c]=b.readableKey(c))})})}):angular.forEach(c,function(a){angular.forEach(a,function(a,c){-1===l.keys.show.indexOf(c)&&(l.keys.show.push(c),l.formattedKeys.show[c]=b.readableKey(c))})}),k.set(l.keys.show),console.log("Keys generated and written to firebase"),p()})},d=a.val();if(d){l.keys.show=d;for(var e=0;e<d.length;e++){var f=l.keys.show[e];l.formattedKeys.show[f]=b.readableKey(f)}}else c();p()};k.on("value",q)},d}]),app.factory("Library",["FIREBASE_URL",function(a){var b={};b.primaryPropertyOf=function(a){return"chatroom"===a?"topic":"message"===a?"text":"name"},b.typeOf=function(a){var b=d[a];return b?b.objectType:void 0};var c=function(a){return a.charAt(0).toUpperCase()+a.slice(1)};b.readableKey=function(a){var b=d[a];return b?b.name:c(a)},b.urlOfKeys=function(b){return a+"adminPanel/settings/dispProperties/"+b},b.types=["user","group","event","chatroom"];var d={eid:{name:"Events",objectType:"event"},eiid:{name:"Event invites",objectType:"event"},eoid:{name:"Events created",objectType:"event"},gid:{name:"Groups",objectType:"group"},gmid:{name:"Member of groups",objectType:"group"},gaid:{name:"Admin of groups",objectType:"group"},rid:{name:"Chat rooms",objectType:"chatroom"},noticeIds:{name:"Notices",objectType:"notice"},member:{name:"Members",objectType:"user"},uid:{name:"Members",objectType:"user"},oid:{name:"Owners",objectType:"user"},aid:{name:"Admins",objectType:"user"},admin:{name:"Admins",objectType:"user"},lastMessage:{name:"Last Message",objectType:"message"},lastRead:{name:"Last Read",objectType:"readReport"}};return b}]);var debug=!1;app.factory("Grouper",["FIREBASE_URL","$firebase",function(a,b){function c(a,c,d,f){if("undefined"!=typeof d){if("undefined"!=typeof arguments[4])var g=arguments[4];console.log(d),angular.forEach(d,function(d,h){var i=b(e.child(a).child(h));console.log("		Remove objectId from the "+a+" "+i.$id+" "),console.log(i.$child(f).$child(c)),debug||i.$child(f).$child(c).$remove(),"undefined"!=typeof g&&g(h)})}}var d=a,e=new Firebase(d),f=b(e),g={};return g.deleteNotice=function(a){var d=f.$child("notice")[a];console.log("deleting notice: "+d.$id),c("group",a,d.gid,"noticeIds");var g=b(e.child("message"));console.log(g.$child(a)),debug||g.$child(a).$remove(),console.log(d),debug||e.child("notice").child(a).remove()},g.deleteEvent=function(a){var d=f.$child("event")[a];console.log("deleting event: "+d.name),console.log(e.child(a).toString()),c("user",a,d.oid,"eoid"),c("user",a,d.uid,"eiid"),c("group",a,d.gid,"eid");var g=b(e.child("rsvp"));console.log(g.$child(a)),debug||g.$child(a).$remove(),console.log(d),debug||e.child("event").child(a).remove()},g.deleteUser=function(a){var d=f.$child("user")[a];console.log("deleting user: "+d.name),console.log(e.child(a).toString()),c("event",a,d.eoid,"oid",function(a){console.log("---Deleting event "+a),g.deleteEvent(a),console.log("---End")}),c("event",a,d.eiid,"uid"),c("group",a,d.gaid,"admin",function(a){console.log("---Deleting group "+a),g.deleteGroup(a),console.log("---End")}),c("group",a,d.gmid,"member"),c("chatroom",a,d.rid,"uid");var h=b(e.child("msisdn"));debug||h.$child(d.msisdn).$remove(),console.log("msisdn"),console.log(h.$child(d.msisdn));var i=b(e.child("rsvp"));angular.forEach(d.eiid,function(b,c){console.log("eiid"),angular.forEach(i.$child(c),function(b,d){console.log("rsvp"),d===a&&(console.log("Delete user from rsvp"),debug||i.$child(c).$child(d).$remove())})}),angular.forEach(d.eoid,function(b,c){console.log("eoid"),angular.forEach(i.$child(c),function(b,d){console.log("rsvp"),d===a&&(console.log("Delete user from rsvp"),debug||i.$child(c).$child(d).$remove())})}),console.log(e.child("gat").child(d.msisdn)),debug||e.child("gat").child(d.msisdn).remove(),console.log("	Deactivating user "+d.name),debug||e.child("user").child(a).child("deactivated").set("true")},g.deleteGroup=function(a){var b=f.$child("group")[a];console.log("deleting group: "+b.name),console.log(e.child(a).toString()),c("user",a,b.admin,"gaid"),c("user",a,b.member,"gmid"),c("event",a,b.eid,"gid"),c("chatroom",a,b.rid,"gid"),c("notice",a,b.notice,"gid"),console.log("	Removeing group "+b.name),debug||e.child("group").child(a).remove()},g}]),app.filter("readableTime",function(){return function(a){var b=new Date(a),c=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],d=c[b.getDay()]+" "+b.getDate()+"."+b.getMonth()+"."+b.getFullYear()+" ";return b.getHours()<10&&(d+="0"),d+=b.getHours()+":",b.getMinutes()<10&&(d+="0"),d+=b.getMinutes()}}),app.filter("mySortFilter",function(){return function(a,b,c){var d=function(a,d){var e=a[b],f=d[b],g="undefined"==typeof e,h="undefined"==typeof f;if(g&&h)return 0;if(g)return 1;if(h)return-1;var i=e.length,j=f.length,k=i-j;return 0===k&&(k=e[0].value>f[0].value?1:-1),c?-k:k},e=[];return angular.forEach(a,function(a){e.push(a)}),e.sort(d)}}),app.filter("mySearchFilter",function(){return function(a,b){if(!b)return a;if("string"==typeof b)var c=function(a){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];if("id"!==c)for(var e in d)if(d.hasOwnProperty(e)){var f=d[e],g=f.value;if("undefined"==typeof g)console.log(c,a,e,f);else if(g.toLowerCase().indexOf(b.toLowerCase())>-1)return!0}}};else if("object"==typeof b)var c=function(){return!0};var d=[];return angular.forEach(a,function(a){c(a)&&d.push(a)}),d}});