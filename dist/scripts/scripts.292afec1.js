"use strict";var app=angular.module("adminPanelApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]);app.config(["$routeProvider",function(a){a.when("/:dataType/:id",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).when("/:dataType",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).otherwise({redirectTo:"/user"})}]).constant("FIREBASE_URL","https://staging-grouper.firebaseio.com/"),app.controller("DynamicCtrl",["$scope","$routeParams","$firebaseSimpleLogin","FIREBASE_URL","Library","DataLoader","Grouper",function(a,b,c,d,e,f,g){a.types=e.types,a.dataType=b.dataType,a.id=b.id,a.setData=function(){f.get(a.dataType,a.id),a.data=f.data},a.forceReload=function(){f.load(a.dataType,a.id),a.data=f.data,k()},a.test=function(){console.log("Scope.auth",a.auth)};var h=function(b,c){b?(console.log("Error logging in: ",b),console.log('If you are an admin, you can add yourself to the "admin"-directory: '+d+"admin"),console.log('Create an entry with the key "github:<your github id>". Find your github id here: http://caius.github.io/github_id/')):c?(console.log("User ID: "+c.uid+", Provider: "+c.provider),a.forceReload()):console.log("Not logged in")},i=new Firebase(d);a.auth=c(i),new FirebaseSimpleLogin(i,h),a.searchValue,a.predicate="",a.reverse=!1,a.setSortingPredicate=function(b){a.predicate===b?a.reverse=!a.reverse:(a.reverse=!1,a.predicate=b)};var j=[];a.selectedObjects=[],a.toggleSelectedRow=function(b,c){var d=j.indexOf(b);-1===d?(j.push(b),a.selectedObjects.push({id:c,name:a.data.objects[c][e.primaryPropertyOf(a.dataType)][0].value})):(j.splice(d,1),a.selectedObjects.splice(d,1))},a.isSelected=function(a){return-1!==j.indexOf(a)},a.deleteSelected=function(){angular.forEach(a.selectedObjects,function(b){switch(a.dataType){case"event":g.deleteEvent(b.id);break;case"user":g.deleteUser(b.id);break;case"group":g.deleteGroup(b.id);break;case"notice":g.deleteNotice(b.id);break;default:console.log("Could not delete: Type unknown! Wtf? ")}delete a.data.objects[b.id],j=[],a.selectedObjects=[]})},a.toggleKey=function(b){var c=a.keys.show.indexOf(b);return c>-1?(a.keys.show.splice(c,1),void a.keys.hide.push(b)):(c=a.keys.hide.indexOf(b),void(c>-1&&(a.keys.hide.splice(c,1),a.keys.show.push(b))))},a.move=function(b,c){for(var d=["show","hide"],e=0;e<d.length;e++){var f=d[e],g=a.keys[f].indexOf(b);if(0===g&&0>c)return;g>-1&&(a.keys[f].splice(g,1),a.keys[f].splice(g+c,0,b))}};var k=function(){var b=new Firebase(e.urlOfKeys(a.dataType));b.on("value",function(b){var c=b.val();if(a.keys=c,a.formattedKeys={},!c)return void console.log("Error: Nothing found at: ",e.urlOfKeys(a.dataType));a.keys.show||(a.keys.show=[]),a.keys.hide||(a.keys.hide=[]);for(var d=c.show.concat(c.hide),f=0;f<d.length;f++){var g=d[f];a.formattedKeys[g]=e.readableKey(g)}}),a.keysToFirebase=function(){b.set(a.keys)}};k()}]),app.factory("DataLoader",["FIREBASE_URL","Library","$filter",function(a,b,c){var d={},e={},f=function(){return{objects:{},keys:{show:[],hide:[]},formattedKeys:{show:{},hide:{}}}};return d.get=function(a,b){e[a]?d.swap(a,b):d.load(a,b)},d.swap=function(a,b){console.log("swap");var c=f();d.data=c,c.keys=e[a].keys,c.formattedKeys=e[a].formattedKeys,b?(c.objects={},c.objects[b]=e[a].objects[b]):c.objects=e[a].objects},d.load=function(g,h){console.log("load");var i=new Firebase(a+g),j=new Firebase(a+g+"/"+h),k=new Firebase(b.urlOfKeys(g)+"/show"),l=new Firebase(b.urlOfKeys(g)+"/hide"),m=f();d.data=m;var n=function(c,d,e,f){var g=a+e+"/"+f,h=b.primaryPropertyOf(e);new Firebase(g).on("value",function(a){var b=a.val();c[d]=b?{ref:e+"/"+f,value:b[h]?b[h]:f}:{value:f}})},o=function(a,c,d){var e=0,f=b.typeOf(d);angular.forEach(a,function(a,b){n(c,e++,f,b)})},p="MMM d yyyy, H:mm",q=function(a,b,d){"object"==typeof d?o(d,a[b]=[],b):"string"==typeof d?a[b]=[{value:d}]:"number"==typeof d?("when"===b||"timeStamp"===b)&&(a[b]=[{value:c("date")(d,p),unixTime:d}]):a[b]="boolean"==typeof d?[{value:d}]:[{value:" [TYPE ERROR] ("+typeof d+") : "+d}]},r=function(a,b){angular.forEach(a,function(a,c){m.keys.show.indexOf(c)>-1&&q(b,c,a)})},s=function(){j.on("value",function(a){var b=a.val(),c={id:h};m.objects[h]=c,r(b,c)})},t=function(){e[g]=m,i.on("value",function(a){angular.forEach(a.val(),function(a,b){var c={id:b};m.objects[b]=c,r(a,c)})})},u=function(){"undefined"!=typeof h?s():t()},v=function(){console.log("Generate keys from data"),i.on("value",function(a){m.keys.show=[];var c=a.val();angular.forEach(c,function(a){angular.forEach(a,function(a,c){-1===m.keys.show.indexOf(c)&&(m.keys.show.push(c),m.formattedKeys.show[c]=b.readableKey(c))})}),k.set(m.keys.show),l.set(["id"]),console.log("Written"),u()})},w=function(a){var c=a.val();if(c){m.keys.show=c;for(var d=0;d<c.length;d++){var e=m.keys.show[d];m.formattedKeys.show[e]=b.readableKey(e)}}else v();u()};k.on("value",w)},d}]),app.factory("Library",["FIREBASE_URL",function(a){var b={};b.primaryPropertyOf=function(a){return"chatroom"===a?"topic":"name"},b.typeOf=function(a){var b=d[a];return b?b.objectType:void 0};var c=function(a){return a.charAt(0).toUpperCase()+a.slice(1)};b.readableKey=function(a){var b=d[a];return b?b.name:c(a)},b.urlOfKeys=function(b){return a+"adminPanel/settings/dispProperties/"+b},b.types=["user","group","event","chatroom"];var d={eid:{name:"Events",objectType:"event"},eiid:{name:"Event invites",objectType:"event"},eoid:{name:"Events created",objectType:"event"},gid:{name:"Groups",objectType:"group"},gmid:{name:"Member of groups",objectType:"group"},gaid:{name:"Admin of groups",objectType:"group"},rid:{name:"Chat rooms",objectType:"chatroom"},noticeIds:{name:"Notices",objectType:"notice"},member:{name:"Members",objectType:"user"},uid:{name:"Members",objectType:"user"},oid:{name:"Owners",objectType:"user"},aid:{name:"Admins",objectType:"user"},admin:{name:"Admins",objectType:"user"}};return b}]),app.factory("FirebaseHolder",["$firebase","FIREBASE_URL",function(a,b){return holder={},holder.url=b,holder.ref=new Firebase(holder.url),holder.angularFire=new a(holder.ref),holder}]);var debug=!1;app.factory("Grouper",["FIREBASE_URL","$firebase","FirebaseHolder",function(a,b,c){function d(a,c,d,f){if("undefined"!=typeof d){if("undefined"!=typeof arguments[4])var g=arguments[4];console.log(d),angular.forEach(d,function(d,h){var i=b(e.child(a).child(h));console.log("		Remove objectId from the "+a+" "+i.$id+" "),console.log(i.$child(f).$child(c)),debug||i.$child(f).$child(c).$remove(),"undefined"!=typeof g&&g(h)})}}var e=c.ref,f={};return f.deleteNotice=function(a){var f=c.angularFire.$child("notice")[a];console.log("deleting notice: "+f.$id),d("group",a,f.gid,"noticeIds");var g=b(e.child("message"));console.log(g.$child(a)),debug||g.$child(a).$remove(),console.log(f),debug||e.child("notice").child(a).remove()},f.deleteEvent=function(a){var f=c.angularFire.$child("event")[a];console.log("deleting event: "+f.name),console.log(e.child(a).toString()),d("user",a,f.oid,"eoid"),d("user",a,f.uid,"eiid"),d("group",a,f.gid,"eid");var g=b(e.child("rsvp"));console.log(g.$child(a)),debug||g.$child(a).$remove(),console.log(f),debug||e.child("event").child(a).remove()},f.deleteUser=function(a){var g=c.angularFire.$child("user")[a];console.log("deleting user: "+g.name),console.log(e.child(a).toString()),d("event",a,g.eoid,"oid",function(a){console.log("---Deleting event "+a),f.deleteEvent(a),console.log("---End")}),d("event",a,g.eiid,"uid"),d("group",a,g.gaid,"admin",function(a){console.log("---Deleting group "+a),f.deleteGroup(a),console.log("---End")}),d("group",a,g.gmid,"member"),d("chatroom",a,g.rid,"uid");var h=b(e.child("msisdn"));debug||h.$child(g.msisdn).$remove(),console.log("msisdn"),console.log(h.$child(g.msisdn));var i=b(e.child("rsvp"));angular.forEach(g.eiid,function(b,c){console.log("eiid"),angular.forEach(i.$child(c),function(b,d){console.log("rsvp"),d===a&&(console.log("Delete user from rsvp"),debug||i.$child(c).$child(d).$remove())})}),angular.forEach(g.eoid,function(b,c){console.log("eoid"),angular.forEach(i.$child(c),function(b,d){console.log("rsvp"),d===a&&(console.log("Delete user from rsvp"),debug||i.$child(c).$child(d).$remove())})}),console.log(e.child("gat").child(g.msisdn)),debug||e.child("gat").child(g.msisdn).remove(),console.log("	Deactivating user "+g.name),debug||e.child("user").child(a).child("deactivated").set("T")},f.deleteGroup=function(a){var b=c.angularFire.$child("group")[a];console.log("deleting group: "+b.name),console.log(e.child(a).toString()),d("user",a,b.admin,"gaid"),d("user",a,b.member,"gmid"),d("event",a,b.eid,"gid"),d("chatroom",a,b.rid,"gid"),d("notice",a,b.notice,"gid"),console.log("	Removeing group "+b.name),debug||e.child("group").child(a).remove()},f}]),app.filter("readableTime",function(){return function(a){var b=new Date(a),c=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],d=c[b.getDay()]+" "+b.getDate()+"."+b.getMonth()+"."+b.getFullYear()+" ";return b.getHours()<10&&(d+="0"),d+=b.getHours()+":",b.getMinutes()<10&&(d+="0"),d+=b.getMinutes()}});