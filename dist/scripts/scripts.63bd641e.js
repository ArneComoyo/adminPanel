"use strict";var app=angular.module("adminPanelApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]);app.config(["$routeProvider",function(a){a.when("/staging",{redirectTo:"/user"}).when("/:dataType/:id/:childId",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).when("/:dataType/:id",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).when("/:dataType",{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"}).otherwise({redirectTo:"/user"})}]),app.constant("FIREBASE_URL","https://staging-grouper.firebaseio.com/"),app.controller("DynamicCtrl",["$scope","$routeParams","$firebase","$firebaseSimpleLogin","$filter","FIREBASE_URL","Library","DataLoader","Grouper",function(a,b,c,d,e,f,g,h,i){!function(){a.firebaseUrl=f,"https://test-grouper.firebaseio.com/"===f&&(a.whichFirebase="Production"),"https://staging-grouper.firebaseio.com/"===f&&(a.whichFirebase="Staging"),"https://interns-grouper.firebaseio.com/"===f&&(a.whichFirebase="Interns Test FB"),a.dataType=b.dataType,a.id=b.id,a.childId=b.childId,a.types=g.types,a.firebaseTypeUrl=f+a.dataType+"/";var c=function(){if("undefined"!=typeof a.id&&"undefined"!=typeof a.childId)var b=a.id+"/"+a.childId;else var b=a.id;return b};a.setData=function(){h.get(a.dataType,c()),a.data=h.data},a.forceReload=function(){h.load(a.dataType,c()),a.data=h.data}}(),function(){var b=function(b,c){b?(a.loggedIn=!1,console.log("Error logging in: ",b),console.log('If you are an admin, you can add yourself to the "admin"-directory: '+f+"admin"),console.log('Create an entry with the key "github:<your github id>". Find your github id here: http://caius.github.io/github_id/')):c?(a.loggedIn=!0,a.setData()):(a.loggedIn=!1,console.log("Not logged in"))},c=new Firebase(f);a.auth=d(c),new FirebaseSimpleLogin(c,b)}();a.filter={},a.html={},a.html.searchValue,a.filter.searchValue,a.delayedUpdateHtmlSearchValue=function(){setTimeout(function(){a.$apply(a.updateHtmlSearchValue)},200)},a.updateHtmlSearchValue=function(){a.html.searchValue="object"==typeof a.filter.searchValue?"<advanced>":a.filter.searchValue},a.search=function(b){if("object"==typeof b){var c=b;b={};var d=!1;for(var e in c)c.hasOwnProperty(e)&&""!==c[e]&&(d=!0,b[e]=c[e]);d||(b="")}a.filter.searchValue=b,a.updateHtmlSearchValue()};var j=!1;a.filter.predicate="",a.filter.reverse=j,a.setSortingPredicate=function(b){a.filter.predicate===b?a.filter.reverse=!a.filter.reverse:(a.filter.reverse=j,a.filter.predicate=b)};!function(){a.selectedObjects={},a.isSelected=function(b){return"object"==typeof a.selectedObjects[b]},a.nofSelectedObjects=function(){return Object.keys(a.selectedObjects).length},a.toggleSelected=function(b){a.isSelected(b)?delete a.selectedObjects[b]:a.selectedObjects[b]=a.data.objects[b]};!function(){var b=function(a){return 0===Object.keys(a).length},c=function(a,b){if(Object.keys(a).length!==Object.keys(b).length)return!1;for(var c in b){var d=b[c].id,e="undefined"!=typeof a[d];if(!e)return!1}return!0},d=function(b){for(var c in b){var d=b[c];a.selectedObjects[d.id]=d}},f=function(){var b=e("mySearchFilter")(a.data.objects,a.filter.searchValue);return b=e("myDeletedUserFilter")(b)};a.allFilteredAreSelected=function(){var b=f();return c(a.selectedObjects,b)},a.toggleSelectFiltered=function(){var e=f();b(a.selectedObjects)?d(e):c(a.selectedObjects,e)?a.selectedObjects={}:(a.selectedObjects={},d(e))}}()}();a.deleteSelected=function(){angular.forEach(a.selectedObjects,function(b){switch(a.dataType){case"event":i.deleteEvent(b.id);break;case"user":i.deleteUser(b.id);break;case"group":i.deleteGroup(b.id);break;case"notice":i.deleteNotice(b.id);break;case"chatroom":i.deleteChatroom(b);break;default:console.log("Could not delete: Type unknown!")}}),a.selectedObjects={}};!function(){a.firebaseKeySettingsUrl=g.urlOfKeys(a.dataType);var b=new Firebase(a.firebaseKeySettingsUrl);b.on("value",function(c){var d=c.val();if(a.keys=d,a.formattedKeys={},!d)return void console.log("Keys not found at: ",g.urlOfKeys(a.dataType));a.keys.show||(a.keys.show=[]),a.keys.hide||(a.keys.hide=[]);for(var e=d.show.concat(d.hide),f=0;f<e.length;f++){var h=e[f];a.formattedKeys[h]=g.readableKey(h)}a.toggleKey=function(b){var c=a.keys.show.indexOf(b);return c>-1?(a.keys.show.splice(c,1),void a.keys.hide.push(b)):(c=a.keys.hide.indexOf(b),void(c>-1&&(a.keys.hide.splice(c,1),a.keys.show.push(b))))},a.move=function(b,c){for(var d=["show","hide"],e=0;e<d.length;e++){var f=d[e],g=a.keys[f].indexOf(b);if(0===g&&0>c)return;g>-1&&(a.keys[f].splice(g,1),a.keys[f].splice(g+c,0,b))}},a.keysToFirebase=function(){b.set(a.keys)}})}()}]),app.factory("DataLoader",["FIREBASE_URL","Library","$filter",function(a,b,c){var d={},e={},f=function(){return{objects:{},keys:{show:[],hide:[]},formattedKeys:{show:{},hide:{}}}};return d.get=function(a,b){e[a]?d.swap(a,b):d.load(a,b)},d.swap=function(a,b){console.log("swap");var c=f();d.data=c,c.keys=e[a].keys,c.formattedKeys=e[a].formattedKeys,b?(c.objects={},c.objects[b]=e[a].objects[b]):c.objects=e[a].objects},d.load=function(g,h){console.log("load");var i=new Firebase(a+g),j=new Firebase(a+g+"/"+h),k=new Firebase(b.urlOfKeys(g)+"/show"),l=(new Firebase(b.urlOfKeys(g)+"/hide"),f());d.data=l;var m=function(d,e,f){if(d){var h=f,i=function(a,c){return b.isNested(a)?a+"/"+h+"/"+c:a+"/"+c},j=function(c,d,e,f,g){var h=i(d,e),j=a+i(d,e),k=b.primaryPropertyOf(d),l=function(a){if(f){g[f]=a;var b=void 0===typeof g.prepend?"":g.prepend,d=void 0===typeof g.append?"":g.append;c.value=b+': "'+d+'"'}else c.value=a};new Firebase(j).on("value",function(a){var b=a.val();if(b){f||(c.ref=h);var d=b[k]?b[k]:e;l(d)}else l(e)})},k=function(a,c,d,e){if(b.hasKeyValuePairs(a)){var f=b.typeOf(a),g=b.secondaryTypeOf(a),h={};j(e,f,c,"prepend",h),j(e,g,d,"append",h);var k=b.remoteTypeOf(a);"undefined"!=typeof k&&(e.ref=i(k,c))}else{var l=b.typeOf(a);j(e,l,c)}},m=function(a,b,c){var d=0;angular.forEach(b,function(b,e){var f={value:""};c[d++]=f,k(a,e,b,f)})},n="MMM d yyyy, H:mm",o=function(a,d,e){if(e){var h={value:""},i=[h];a[d]=i,"object"==typeof e?m(d,e,i):("string"==typeof e?b.hasReference(d)?k(d,e,void 0,h):h.value=e:"number"==typeof e?"when"===d||"timeStamp"===d||"lastLogin"===d?(h.value=c("date")(e,n),h.unixTime=e):h.value=e:h.value="boolean"==typeof e?e:" [TYPE ERROR] ("+typeof e+") : "+e,d===b.primaryPropertyOf(g)&&(h.ref=g+"/"+f))}};angular.forEach(d,function(a,b){l.keys.show.indexOf(b)>-1&&o(e,b,a)});{(function(){var c=b.remoteProperties(g);if(c)for(var d=0;d<c.length;d++){var h=c[d];if(l.keys.show.indexOf(h)>-1){var i=b.remoteTypeOf(h),j=new Firebase(a+i+"/"+f);j.on("value",function(a){var b=a.val();o(e,h,b)})}}})(),function(){if("chatroom"===g){var b="name";if(l.keys.show.indexOf(b)>-1){e[b]=[{value:"Chatroom: ",ref:g+"/"+f}];var c=!1;if(d.gid){c=!0;var h=a+"group/"+Object.keys(d.gid)[0]+"/name",i=new Firebase(h);i.on("value",function(a){e[b][0].value+="{"+a.val()+"}"})}if(d.uid){c=!0;for(var j=Object.keys(d.uid),k=0,m=0;m<j.length;m++){var n=j[m],o=new Firebase(a+"user/"+n+"/name");o.on("value",function(a){var c=++k<j.length?", ":".";e[b][0].value+=a.val()+c})}}c||(e[b][0].value+="No members!")}}}()}}},n=function(){j.on("value",function(a){if(!a.val())return void delete l.objects[h];var b=a.val(),c={id:h};l.objects[h]=c,m(b,c,h)})},o=function(){e[g]=l;var a=function(a){var b=a.val(),c=a.name(),d={id:c};l.objects[c]=d,m(b,d,c)},b=function(a){var b=a.name();delete e[g].objects[b]};i.on("child_added",a),i.on("child_changed",a),i.on("child_removed",b)},p=function(){"undefined"!=typeof h?n():o()},q=function(a){var c=function(){console.log("Generate keys from data"),i.once("value",function(a){l.keys.show=[];var c=a.val();b.isNested(g)?angular.forEach(c,function(a){angular.forEach(a,function(a){angular.forEach(a,function(a,c){-1===l.keys.show.indexOf(c)&&(l.keys.show.push(c),l.formattedKeys.show[c]=b.readableKey(c))})})}):angular.forEach(c,function(a){angular.forEach(a,function(a,c){-1===l.keys.show.indexOf(c)&&(l.keys.show.push(c),l.formattedKeys.show[c]=b.readableKey(c))})}),k.set(l.keys.show),console.log("Keys generated and written to firebase"),p()})},d=a.val();if(d){l.keys.show=d;for(var e=0;e<d.length;e++){var f=l.keys.show[e];l.formattedKeys.show[f]=b.readableKey(f)}}else console.log("No keys found! "+b.urlOfKeys(g),d),c();p()};k.on("value",q)},d}]),app.factory("Library",["FIREBASE_URL",function(a){var b={};b.primaryPropertyOf=function(a){return"message"===a?"text":"name"},b.typeOf=function(a){var b=d[a];return b?b.objectType:void 0},b.secondaryTypeOf=function(a){var b=d[a];return b&&b.secondaryType?b.secondaryType:void 0},b.remoteTypeOf=function(a){var b=d[a];return b&&b.remoteType?b.remoteType:void 0},b.remoteProperties=function(a){return"chatroom"===a||"notice"===a?["importMessages"]:"event"===a?["importRsvps"]:void 0},b.hasKeyValuePairs=function(a){return"lastRead"===a||"readReport"===a||"importRsvps"===a},b.hasReference=function(a){return"lastMessage"===a||"firstMessage"===a},b.isNested=function(a){return"message"===a||"rsvp"===a};var c=function(a){return"string"!=typeof a||""===a?a:a.charAt(0).toUpperCase()+a.slice(1)};b.readableKey=function(a){var b=d[a];return b?b.name:c(a)},b.urlOfKeys=function(b){return a+"adminPanel/settings/dispProperties/"+b},b.types=["user","group","event","chatroom","notice"];var d={eid:{name:"Events",objectType:"event"},eiid:{name:"Event invites",objectType:"event"},eoid:{name:"Events created",objectType:"event"},gid:{name:"Groups",objectType:"group"},gmid:{name:"Member of groups",objectType:"group"},gaid:{name:"Admin of groups",objectType:"group"},rid:{name:"Chat rooms",objectType:"chatroom"},noticeIds:{name:"Notices",objectType:"notice"},member:{name:"Members",objectType:"user"},uid:{name:"Members",objectType:"user"},oid:{name:"Owners",objectType:"user"},aid:{name:"Admins",objectType:"user"},admin:{name:"Admins",objectType:"user"},from:{name:"From",objectType:"user"},lastRead:{name:"Last Read",objectType:"user",secondaryType:"message"},readReport:{name:"Read report",objectType:"user",secondaryType:"message"},lastMessage:{name:"Last Message",objectType:"message"},firstMessage:{name:"First Message",objectType:"message"},importMessages:{name:"Messages",objectType:"message",remoteType:"message"},importRsvps:{name:"RSVP",objectType:"user",remoteType:"rsvp"},rsvp:{name:"RSVP",objectType:"user"}};return b}]);var debug=!1;app.factory("Grouper",["FIREBASE_URL","$firebase",function(a,b){function c(a,c,d,f,g){"undefined"!=typeof d&&angular.forEach(d,function(d,h){var i=b(e.child(a).child(h));console.log("		Remove backward reference from the "+a+" "+i.$id+". 	",i.$child(f).$child(c)),debug||i.$child(f).$child(c).$remove(),"undefined"!=typeof g&&g(h)})}var d=a,e=new Firebase(d),f=b(e),g={},h={queued:[],add:function(a,b){this.queued.push({func:a,id:b})},hasNext:function(){return this.queued.length>0},performNext:function(){if(this.hasNext()){var a=this.queued.pop();a.func(a.id)}}};return g.deleteNotice=function(a){var b=f.$child("notice")[a],d=e.child("notice").child(a);if(!b)return console.log("Deleting notice: ERROR: Nothing at reference location: "+d.toString()),void h.performNext();console.log("Deleting notice: "+b.name+" "+d.toString()),c("group",a,b.gid,"noticeIds");var g=e.child("message").child(a);console.log("- deleting messages: "+g.toString()),debug||g.remove(),debug||d.remove(),h.performNext()},g.deleteEvent=function(a){var d=f.$child("event")[a],g=e.child("event").child(a);if(!d)return console.log("Deleting event: ERROR: Nothing at reference location: "+g.toString()),void h.performNext();console.log("Deleting event: "+d.name+" "+g.toString()),c("user",a,d.oid,"eoid"),c("user",a,d.uid,"eiid"),c("group",a,d.gid,"eid");var i=b(e.child("rsvp"));console.log(i.$child(a)),debug||i.$child(a).$remove(),console.log(d),debug||g.remove(),h.performNext()},g.deleteUser=function(b){var d=f.$child("user")[b],i=e.child("user").child(b);if(!d)return console.log("Deleting user: ERROR: Nothing at reference location: "+i.toString()),void h.performNext();console.log("Deleting user: "+d.name+" "+i.toString()),console.log("gmid"),c("group",b,d.gmid,"member"),console.log("gaid"),c("group",b,d.gaid,"admin",function(b){console.log("Delete group owned by user: "+a+"group/"+b),g.deleteGroup(b)}),c("event",b,d.eiid,"uid"),console.log("eoid"),c("event",b,d.eoid,"oid",function(b){console.log("Delete event owned by user: "+a+"event/"+b),g.deleteEvent(b)});for(var j in d.eiid)if(console.log("Removing rsvp: "+a+"rsvp/"+j+"/"+b),!debug)try{e.child("rsvp").child(j).child(b).remove()}catch(k){console.log("No rsvp made for this event.")}try{console.log("Removing msisdn: "+a+"msisdn/"+d.msisdn),debug||e.child("msisdn").child(d.msisdn).remove()}catch(k){console.log("Msisdn not found")}try{console.log("Remove GAT: "+a+"gat/"+d.msisdn),debug||e.child("gat").child(d.msisdn).remove()}catch(k){console.log("Gat not found")}var l=!0;l?(console.log("Erasing user:"+d.name,i.toString()),debug||i.remove()):(console.log("Deactivating user "+d.name,i.toString()),debug||i.child("deactivated").set(!0)),h.performNext()},g.deleteGroup=function(a){var b=f.$child("group")[a],d=e.child("group").child(a);return b?(console.log("Deleting group: "+b.name+" "+d.toString()),c("user",a,b.admin,"gaid"),c("user",a,b.member,"gmid"),c("event",a,b.eid,"gid"),c("chatroom",a,b.rid,"gid"),c("notice",a,b.notice,"gid",function(a){g.deleteNotice(a)}),console.log("	Removing group: "+b.name),debug||d.remove(),void h.performNext()):(console.log("Deleting group: ERROR: Nothing at reference location: "+d.toString()),void h.performNext())},g.deleteChatroom=function(b){var d=b.id,g=f.$child("chatroom")[d],i=e.child("chatroom").child(d);if(!g)return console.log("Deleting chatroom: ERROR: Nothing at reference location: "+i.toString()),void h.performNext();var j=b.name?b.name[0].value:"";console.log("Deleting chatroom: "+j+" "+i.toString()),c("user",d,g.uid,"rid"),c("group",d,g.gid,"rid"),console.log("deleting messages: "+a+"message/"+d),debug||e.child("message").child(d).remove(),debug||e.child("chatroom").child(d).remove(),h.performNext()},g}]),app.filter("readableTime",function(){return function(a){var b=new Date(a),c=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],d=c[b.getDay()]+" "+b.getDate()+"."+b.getMonth()+"."+b.getFullYear()+" ";return b.getHours()<10&&(d+="0"),d+=b.getHours()+":",b.getMinutes()<10&&(d+="0"),d+=b.getMinutes()}}),app.filter("mySortFilter",function(){return function(a,b,c){var d=function(a,d){var e=a[b],f=d[b],g="undefined"==typeof e,h="undefined"==typeof f;if(g&&h)return 0;if(g)return 1;if(h)return-1;var i=e.length,j=f.length,k=i-j;if(0===k)try{var l=e[0].unixTime?e[0].unixTime:e[0].value,m=f[0].unixTime?f[0].unixTime:f[0].value;k=l>m?1:-1}catch(n){console.log("Sort error: ",n,"params: ",a,e,d,f)}return c?-k:k},e=[];return angular.forEach(a,function(a){e.push(a)}),e.sort(d)}}),app.filter("mySearchFilter",function(){return function(a,b){if(!b)return a;var c=function(a,b){if("undefined"==typeof a)return!1;if("string"!=typeof a){if("object"==typeof a)return console.log("Err: value is object! ",a),!1;a=""+a}return a.toLowerCase().indexOf(b.toLowerCase())>-1?!0:void 0};if("string"==typeof b)var d=function(a){for(var d in a)if(a.hasOwnProperty(d)&&"$$hashKey"!==d){var e=a[d];if("id"!==d)for(var f in e)if(e.hasOwnProperty(f)){var g=e[f],h=g.value;if(c(h,b))return!0}}return!1};else{if("object"!=typeof b)return a;var d=function(a){for(var d in b){var e=!1;if(b.hasOwnProperty(d)&&""!==b[d]){var f=a[d];for(var g in f)if(f.hasOwnProperty(g)){var h=f[g],i=h.value;c(i,b[d])&&(e=!0)}}if(!e)return!1}return!0}}var e=[];return angular.forEach(a,function(a){d(a)&&e.push(a)}),e}}),app.filter("myDeletedUserFilter",function(){return function(a,b){if("user"!==b)return a;for(var c=function(a){return a.deactivated&&a.deactivated[0].value===!0?!1:!0},d=[],e=0;e<a.length;e++)c(a[e])&&d.push(a[e]);return d}});